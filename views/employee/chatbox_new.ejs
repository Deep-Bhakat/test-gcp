<%- include('../includes/newHeader.ejs') %>

<!-- CSS only -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">


<link rel="stylesheet" type="text/css" href="../fontawesome/css/all.css" />

<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />

<link 
  href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/font-awesome.css/all.min.css" 
  rel="stylesheet"  type='text/css'> 
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script src="https://kit.fontawesome.com/440227bcb8.js" crossorigin="anonymous"></script>
<!-- JavaScript Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous"></script>
<style>
    @charset "utf-8";


body
{
	margin:0;
	font:normal 12px/18px Arial, Helvetica, sans-serif;
	
	margin-top:0px;
}

.btop
{
border-style: ridge none ridge none;
line-height:30px;
padding-left:20px;


  
}

.bbright
{
border-style: hidden ridge none  none ;
line-height:30px;
padding-left:20px;


  
}

.bbleft
{
border-style:  hidden  hidden    none ridge;
line-height:30px;
padding-left:20px;


  
}
.bbottom
{
border-bottom:solid 1px #333;
}
.bright
{
border-right:solid 1px #333;
}
.bleft
{
border-left:solid 1px #333;
}

/* body {
        margin: 0;
        padding: 0;
        background-color: #FAFAFA;
        font: 12pt "Tahoma";
    }
    * {
        box-sizing: border-box;
        -moz-box-sizing: border-box;
    }
    .page {
        width: 21cm;
        min-height: 29.7cm;
        padding: 2cm;
        margin: 1cm auto;
        border: 1px #D3D3D3 solid;
        border-radius: 5px;
        background: white;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    }
    .subpage {
        padding: 1cm;
        border: 5px red solid;
        height: 237mm;
        outline: 2cm #FFEAEA solid;
    }*/
    .page {
        width: 21cm; 
        min-height: 29.7cm;
        /*padding: 2cm;*/
		 padding: 5px 25px;
        margin: 1cm auto;
        border: 1px #D3D3D3 solid;
        border-radius: 5px;
        background: white;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    }
    @page {
        size: A4;
        margin: 0;
    }
    @media print {
        .page {
            margin: 0;
            border: initial;
            border-radius: initial;
            width: initial;
            min-height: initial;
            box-shadow: initial;
            background: initial;
            page-break-after: always;
        }
    }
/*######################print page css start###########################*/	
	.subheading{
font-weight:700;
font-family:"Times New Roman", Times, serif;
text-align:center;
margin-buttom:15px;
font-size:17px;}
.title{
font-weight:700;
font-family:"Times New Roman", Times, serif;
text-align:left;
margin-buttom:20px;
font-size:15px;
}
.test{
font-weight:700;
font-family:"Times New Roman", Times, serif;
text-align:left;
margin-buttom:20px;
font-size:15px;
}
.heading
{
text-transform:uppercase; 
padding-top:5px; 
padding-bottom:5px; 
margin-top:5px;
margin-left:auto;
margin-right:auto;
border-top:#FF0000;
margin-bottom:15px;
font-weight:700;
border-top:solid 2px;
border-bottom:#FF0000;
border:2px;
font-family:"Times New Roman", Times, serif;
text-align:center;
font-size:20px;}
.patient {
font-weight:700;
font-family:"Times New Roman", Times, serif;
text-align:left;
margin-buttom:20px;
font-size:12px;
}
.nb {
font-weight:700;
font-family:"Times New Roman", Times, serif;
text-align:left;
margin-buttom:20px;
font-size:11px;
}
.comments{
font-weight:700;
font-family:"Times New Roman", Times, serif;
text-align:left;
margin-buttom:20px;
font-size:12px;
}
.below {
font-weight:700;
font-family:"Times New Roman", Times, serif;
text-align:center;
/*margin-buttom:20px;*/
/*margin-top:500px;*/
position:absolute;
top:1014px;
margin-left:30px;
font-size:10px;

}
/*######################print page css end###########################*/	
img {
  border-radius: 50%;
}
.name{
font-size:18px;
text-align: center; }
.time{
font-size:10px;
text-transform:uppercase;}
.genesis{
font-size:16px;
font-weight:bold;}
.circle {
        border-radius: 50%;
        width: 10px;
        height: 10px;
        padding: 5px;
        background: #fff;
        border: 3px solid green;
        color: green;
        text-align: center;
        font: 10px Arial, sans-serif;
      }
      
.clearfix:after {
  visibility: hidden;
  display: block;
  font-size: 0;
  content: " ";
  clear: both;
  height: 0;
}

.chat-message {
  padding: 30px;
}
 .chat-message textarea {
  width: 100%;
  border: 1px solid black;
  padding: 10px 20px;
  font: 14px/22px "Lato", Arial, sans-serif;
  margin-bottom: 10px;
  border-radius: 5px;
  resize: none;
}
 .chat-message .fa-file-o,
 .chat-message .fa-file-image-o {
  font-size: 16px;
  color: gray;
  cursor: pointer;
}
 /* .chat-message button {
  float: right;
  font-size: 16px;
  background-color: blue;
  text-transform: uppercase;
  border: none;
  cursor: pointer;
  font-weight: bold;
  background: #f2f5f8;
} */

.circle2 {
        border-radius: 50%;
        width: 10px;
        height: 10px;
        padding: 5px;
        background: #fff;
        border: 3px solid red;
        color: red;
        text-align: center;
        font: 10px Arial, sans-serif;
      }
</style>

</head>
<body>
<div class="container-fluid">
<div class="row">
<div align="center" class="col-12">
<h4> Welcome to Genesis Chit Chat Room</h4>
</div>
</div>
<div class="row">
<div class="col-3 btop genesis "> Genesis Member

</div>
<div class="col-9 btop genesis name2" style="text-align:left; padding-left:50px;"> 
</div>
</div>
<div class="row ">
<div class="col-3 ullist">
    <div class="row">
        <div align="right" class="col-1 " style=" padding-top:5px;"><img src="../img/chatlogo.png" width="auto" height="40px;" />
        </div>
        <div class="col-4 " style="text-align:center; padding-top:15px; cursor: pointer;" onclick="getChats('admin','Admin')">Admin   
        </div>
        <!-- <div align="left" class="col-1 bbright" style="padding-right: 10px; padding-top:15px; margin-right: 10px;"> -->
          <!-- <span class="circle2"><%= noOfChatsAdmin[0] %></span>   -->
              <!-- </div> -->
        </div>
<% for(let c=0; c<users.length; c++){ %>  
    <div class="row">
        <div align="right" class="col-1 " style=" padding-top:5px;"><img src="../img/chatlogo.png" width="auto" height="40px;" />
        </div>
        <div class="col-4 " style="text-align:center; padding-top:15px; cursor: pointer;" onclick="getChats(<%= users[c].id %>,'<%= users[c].name %>')"><%= users[c].name %>    
        </div>
        <!-- <div align="left" class="col-1 bbright" style="padding-right: 10px; padding-top:15px; margin-right: 10px;"> -->
          <!-- <span class="circle"><%= noOfChats[c] %></span>    -->
             <!-- </div> -->
        </div>
<% } %>



</div>
<div align="center" class="col-9 " style="margin-top:50px;"><img src="../img/chatlogo.png" width="auto" height="100px;" /> <br />
<p class="name"> </p>
<input type="hidden" id="userId" />
<input type="hidden" id="userName" />
<input type="hidden" id="userToChat" value="<%= userToChat %>" />
<input type="hidden" id="userToChatName" value="<%= userToChatName %>" />
<!-- <p class="time"> Thursday, Oct, 25</p> -->
<ul id="chatsUl" style="list-style: none; overflow-x: hidden; overflow-y: scroll; height: 300px;">

<!-- <div class="row">
<div class="col-1" style="text-align:right;">
<img src="../img/chatlogo.png" width="auto" height="40px;" />
</div>
<div class="col-9 " style="text-align:left"><strong> Ram Babu  Das</strong> <span> Tue, 10:40 AM</span><br />
<span style="text-align:justify;"> it is testing it is testing please ignore it it is testing it is testing please ignore itit is testing it is testing please ignore itit is testing it is testing please ignore itit is testing it is testing please ignore itit is testing it is testing please ignore itit is testing it is testing please ignore itit is testing it is testing please ignore itit is testing it is testing please ignore itit is testing it is testing please ignore itit is testing it is testing please ignore itit is testing it is testing please ignore itit is testing it is testing please ignore itit is testing it is testing please ignore itit is testing it is testing please ignore itit is testing it is testing please ignore itit is testing it is testing please ignore itit is testing it is testing please ignore itit is testing it is testing please ignore itit is testing it is testing please ignore itit is testing it is testing please ignore itit is testing it is testing please ignore itit is testing it is testing please ignore it</span>
</div>
<div class="2">
<p></p>
</div>
</div> -->

  
    </ul>
<div class="chat-message clearfix">
    <textarea name="message-to-send" id="message-to-send" placeholder ="Type your message" rows="3"></textarea>
    <input type="hidden" id="userId" />
    <input type="hidden" id="userName" />
    <input type="hidden" id="sender_name" value="<%= sender_name %>" />
    <input type="hidden" id="senderId" value="<%= senderId %>" />
    <input type="hidden" id="userToChat" value="<%= userToChat %>" />
    <input type="hidden" id="userToChatName" value="<%= userToChatName %>" />
    <!-- <i class="fa fa-file-o"></i> &nbsp;&nbsp;&nbsp; -->
    <!-- <i class="fa fa-file-image-o"></i> -->
    
    <button class="btn btn-primary" onclick="sendMsg()">Send</button>

  </div>
</div>
</div>
</div>
</body>
</html>

<script>
   function formatTime(timeString) {
    var [hourString, minute] = timeString.split(":");
    const hour = +hourString % 24;
    if(minute<=9){
      minute = "0"+minute;
    }
    return (hour % 12 || 12) + ":" + minute +' '+ (hour < 12 ? "AM" : "PM");
}
    var userToChat = document.getElementById('userToChat').value;
    var userToChatName = document.getElementById('userToChatName').value;
    var sender_name = document.getElementById('sender_name').value;
    if(userToChat!=''){
      getChats(userToChat,userToChatName);
    }
    function addSentMessage(msg,date,time,name){
      const date1 = new Date(date);
      // var timeStart = new Date(date +' '+ time).getHours();
      // var timeStartMin = new Date(date +' '+ time).getMinutes();
       time = formatTime(time);
      const dd = date.substr(8,2);
      const mm = date.substr(5,2);
      const yy = date.substr(2,2);
      var date = dd+'/'+mm+'/'+yy;

      const date2 = new Date();
      const diffTime = Math.abs(date2 - date1);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
      // today's date
      if(diffDays==1){
          date = 'Today';
      }else if(diffDays==2){
          date = 'Yesterday';
      }else if(diffDays<=7){
          date = date1.toLocaleString('en-us', {weekday:'long'})
      }
    //   var aa = `<li class="clearfix">
    //   <div class="message-data align-right">
    //     <span class="message-data-time" >${dd}/${mm}/${yy} ${time}</span> &nbsp; &nbsp;
    //     <span class="message-data-name" ></span> <i class="fa fa-circle me"></i>
    //   </div>
    //   <div class="message other-message float-right">
    //       ${msg}
    //   </div>
    // </li>`;

    var aa = `  <div class="row">
        <div class="col-1" style="text-align:right;">
        <img src="../img/chatlogo.png" width="auto" height="40px;" />
        </div>
        <div class="col-9 " style="text-align:left"><span style="text-decoration:uppercase;"><strong> ${name} </strong></span> <span>${date} ${time}</span><br />
        <span style="text-align:justify;">${msg}</span>
        </div>
        <div class="2">
        <p></p>
        </div>
        </div>`;
    document.getElementById('chatsUl').innerHTML+=aa;
    }
    function addReceivedMessage(msg,date,time,name){
      const date1 = new Date(date);
      // var timeStart = new Date(date +' '+ time).getHours();
      // var timeStartMin = new Date(date +' '+ time).getMinutes();
       time = formatTime(time);
      const dd = date.substr(8,2);
      const mm = date.substr(5,2);
      const yy = date.substr(2,2);
      var date = dd+'/'+mm+'/'+yy;

      const date2 = new Date();
      const diffTime = Math.abs(date2 - date1);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
      // today's date
      if(diffDays==1){
          date = 'Today';
      }else if(diffDays==2){
          date = 'Yesterday';
      }else if(diffDays<=7){
          date = date1.toLocaleString('en-us', {weekday:'long'})
      }
    //   var aa=`<li>
    //   <div class="message-data">
    //     <span class="message-data-name"><i class="fa fa-circle online"></i></span>
    //     <span class="message-data-time">${dd}/${mm}/${yy} ${time}</span>
    //   </div>
    //   <div class="message my-message">
    //     ${msg}
    //   </div>
    // </li>`;
    var aa = `  <div class="row">
        <div class="col-1" style="text-align:right;">
        <img src="../img/chatlogo.png" width="auto" height="40px;" />
        </div>
        <div class="col-9 " style="text-align:left"><span style="text-decoration:uppercase;"><strong> ${name} </strong></span> <span>${date} ${time}</span><br />
        <span style="text-align:justify;">${msg}</span>
        </div>
        <div class="2">
        <p></p>
        </div>
        </div>`;
    document.getElementById('chatsUl').innerHTML+=aa;
  
    }
  
      function getChats(receiver_id,name){
        document.getElementsByClassName('name')[0].innerHTML = name;
        document.getElementsByClassName('name2')[0].innerHTML = name;
        document.getElementById('userId').value=receiver_id;      
        var sender_id =document.getElementById('senderId').value;

        document.getElementById('userName').value=name;
          $.ajax({
          type: 'POST',
          url: '/employee/getUserChats',
          data: {receiver_id:receiver_id,sender_id:sender_id},
          success: function(chats) {
            document.getElementById('chatsUl').innerHTML='';
              // console.log(chats);
            for(var i =0;i<chats.length;i++){
              if(chats[i].to == sender_id){
                addReceivedMessage(chats[i].message,chats[i].date,chats[i].time,chats[i].from_name);
                document.querySelector("#chatsUl").scrollTop=document.querySelector("#chatsUl").scrollHeight;
  
              }else{
                addSentMessage(chats[i].message,chats[i].date,chats[i].time,chats[i].from_name);
                document.querySelector("#chatsUl").scrollTop=document.querySelector("#chatsUl").scrollHeight;
  
              }
            }
          }
      });
  
      document.querySelector("#chatsUl").scrollTop=document.querySelector("#chatsUl").scrollHeight;
  
      }
      setInterval(()=>{
        if(document.getElementById('userId').value!='')
        getChats(document.getElementById('userId').value,  document.getElementById('userName').value)
      },5000);     
     function sendMsg(){
      var receiver_id =   document.getElementById('userId').value;
      var msg =   document.getElementById('message-to-send').value;
      var date = new Date();
      var newDate = date.getFullYear() + '-' + (date.getMonth()+1) + '-' + date.getDate();
      // var time = date.toLocaleTimeString();
      let currentDateTime = new Date();
      let time = currentDateTime.getHours() + ":" + currentDateTime.getMinutes() +":" + currentDateTime.getSeconds();
     
       var sender_id =document.getElementById('senderId').value;
      addSentMessage(msg,newDate,time,sender_name);
      $.post({
        type: 'POST',
          url: '/employee/addUserChat',
          data: {receiver_id:receiver_id,sender_id:sender_id,from_name:sender_name,to_name: document.getElementById('userName').value,msg:msg,date:newDate,time:time},
          success: function(chats) {
  
          }  
      });
      document.getElementById('message-to-send').value='';
  
     }
    //  setInterval(()=>{
    //         $.post({
    //   type: 'GET',
    //     url: '/employee/countChats',
    //     // data: {},
    //     success: function({noOfChats,noOfChatsAdmin}) {
    //       // console.log(noOfChats);
    //       // console.log(noOfChatsAdmin);
    //       var c = document.getElementsByClassName('circle').length;
    //       for(var i = 0;i<c;i++){
    //         document.getElementsByClassName('circle')[i].innerHTML = noOfChats[i];
    //       }
    //         document.getElementsByClassName('circle2')[0].innerHTML = noOfChatsAdmin[0];
          
    //     }  
    // });
      
    // },1000);  

    setInterval(()=>{
            $.post({
      type: 'GET',
        url: '/employee/countChats',
        // data: {},
        success: function({noOfChats,noOfChatsAdmin}) {
           console.log(noOfChats);
          var c = document.getElementsByClassName('circle').length;
          document.getElementsByClassName('ullist')[0].innerHTML = '';
          if(noOfChatsAdmin[i]>0){
            hasChats = 1;
          }
            // document.getElementsByClassName('circle22')[0].innerHTML = ' - '.noOfChatsAdmin[0];
            var aaa = `<div class="row">
        <div align="right" class="col-1 " style=" padding-top:5px;"><img src="../img/chatlogo.png" width="auto" height="40px;" />
        </div>
        <div class="col-4 " style="text-align:center; padding-top:15px; cursor: pointer;" onclick="getChats(admin,'Admin')"> Admin   &nbsp;&nbsp;  <span class="">${noOfChatsAdmin[0] >0 ? '- '+noOfChatsAdmin[0] : ''}</span>
        </div>
       
        </div>
        <hr width="150px;">

`;
document.getElementsByClassName('ullist')[0].innerHTML += aaa;
          

        

          for(var i = 0;i<noOfChats.length;i++){
            var aa = `<div class="row">
        <div align="right" class="col-1 " style=" padding-top:5px;"><img src="../img/chatlogo.png" width="auto" height="40px;" />
        </div>
        <div class="col-4 " style="text-align:center; padding-top:15px; cursor: pointer;" onclick="getChats(${noOfChats[i].id},'${noOfChats[i].name}')">${noOfChats[i].name}   &nbsp;&nbsp;  <span class="">${noOfChats[i].count >0 ? '- '+noOfChats[i].count : ''}</span>
        </div>
       
        </div>
        <hr width="150px;">

`;
// console.log(aa);
document.getElementsByClassName('ullist')[0].innerHTML += aa;

            if(noOfChats[i]>0){
              hasChats = 1;
            // document.getElementsByClassName('circle')[i].innerHTML = noOfChats[i];
            }
          }
       
          if(hasChats){
            document.getElementById('hasChatsSpan').style.display='';
          }else{
            document.getElementById('hasChatsSpan').style.display='none';

          }
        }  
    });
      
    },1000);  

  </script>